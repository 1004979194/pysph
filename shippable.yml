language: python

# See here: http://docs.shippable.com/en/latest/config.html#caching-minions
# Add [reset_minion] to the commit message to reset the minion.
cache: true

python:
    - 2.7
    - 3.4

# This doesn't work yet on shippable but we keep it here in case it does.
virtualenv:
    system_site_packages: true

env:
    - ZOLTAN=$HOME/zoltan BUILD_DIR=$HOME/build_$SHIPPABLE_PYTHON

before_install:
    # System dependencies via apt.
    - echo $BUILD_DIR
    - sudo apt-get install build-essential python-dev libopenmpi-dev
    - if [[ $SHIPPABLE_PYTHON == "2.7.3" ]]; then
        sudo apt-get install cython python-numpy python-mako python-mpi4py python-nose;
      fi
    - if [[ $SHIPPABLE_PYTHON == "3.4.1" ]]; then
        sudo apt-get install cython3 python3-numpy python3-mako python3-mpi4py python3-nose;
      fi

    # Build zoltan.
    - ./build_zoltan.sh $ZOLTAN

    # Setup the virtual env.
    - deactivate # Deactivate the current virtualenv
    - mkdir -p $BUILD_DIR
    - virtualenv --system-site-packages -p $SHIPPABLE_PYTHON  $BUILD_DIR
    - source $BUILD_DIR/bin/activate

install:
    # We need a recent version of Cython.
    - pip install -r requirements.txt
    # Build pysph.
    - make clean
    - python setup.py install

before_script:
    - rm -rf ~/.pysph/source
    - mkdir -p shippable/testresults

script:
    - nosetests -v -A slow --with-xunit --xunit-file=shippable/testresults/nosetests.xml -w docs pyzoltan pysph

