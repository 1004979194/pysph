language: python

python:
    - 2.7
    - 3.5

env:
    - ZOLTAN=$HOME/zoltan


build:

    ci:
        - "export BUILD_DIR=$HOME/build_$TRAVIS_PYTHON_VERSION"
        - env

        # System dependencies via apt.
        - sudo apt-get update
        - sudo apt-get install -y build-essential python-dev libopenmpi-dev curl
        - |
          if [[ $TRAVIS_PYTHON_VERSION == "2.7" ]]; then
          sudo apt-get install -y cython python-numpy python-mako python-mpi4py python-nose;
          sudo dpkg --remove --force-depends python-six;
          fi
        - |
          if [[ $TRAVIS_PYTHON_VERSION == "3.4" ]]; then
          sudo apt-get install -y cython3 python3-numpy python3-mako python3-mpi4py python3-nose;
          fi

        # Build zoltan.
        - ./build_zoltan.sh $ZOLTAN

        # Setup the virtual env.
        - rm -rf $BUILD_DIR
        - mkdir -p $BUILD_DIR
        - virtualenv --system-site-packages -p /usr/bin/python$TRAVIS_PYTHON_VERSION $BUILD_DIR
        - source $BUILD_DIR/bin/activate

        # We need a recent version of Cython.
        - pip install -r requirements.txt
        # Build pysph.
        - make clean
        - python setup.py install

        - rm -rf ~/.pysph/source
        - mkdir -p $TRAVIS_BUILD_DIR/shippable/testresults

        - python -m nose.core -v -A slow --with-xunit --xunit-file=$TRAVIS_BUILD_DIR/shippable/testresults/nosetests.xml -w docs pyzoltan pysph
